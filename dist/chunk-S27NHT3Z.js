import {a,d,e}from'./chunk-5RMT5B2R.js';import {spawn}from'child_process';import g from'fs';import w from'net';import h from'os';import P from'path';function o(p){return new Promise((r,t)=>{let n=w.createConnection(e()),e$1="";n.on("connect",()=>{n.write(JSON.stringify(p)+`
`);}),n.on("data",i=>{e$1+=i.toString();let s=e$1.split(`
`);e$1=s.pop()??"";for(let m of s)if(m.trim())try{let a=JSON.parse(m);n.destroy(),a.ok?r(a.data):t(new Error(a.error));}catch(a){n.destroy(),t(a);}}),n.on("error",i=>t(i)),n.setTimeout(1e4,()=>{n.destroy(),t(new Error("IPC timeout"));});})}var u=class{daemonScript;constructor(r){this.daemonScript=r??P.join(a,"daemon.js");}async isDaemonRunning(){try{return d.info("[ZPM]","Daemon is Running :?"),await o({cmd:"ping"}),!0}catch{return d.info("[ZPM]","Daemon is not running."),false}}async ensureDaemon(){if(await this.isDaemonRunning()){d.info("[ZPM]","Daemon is Running :)");return}console.log("[ZPM] Spawning daemon..."),spawn(process.execPath,[this.daemonScript],{detached:true,stdio:"ignore"}).unref(),await this.waitForDaemon(8e3);}async killDaemon(){let r=P.join(h.tmpdir(),"zuzjs-pm.pid");if(!g.existsSync(r))throw new Error("Daemon PID file not found \u2013 is the daemon running?");let t=Number(g.readFileSync(r,"utf8").trim());try{process.kill(t,"SIGTERM"),console.log(`[ZPM] Sent SIGTERM to daemon (PID ${t})`);}catch(n){throw new Error(`Failed to kill daemon: ${n.message}`)}}async start(r){return o({cmd:"start",name:r.name,config:r})}async stop(r){return o({cmd:"stop",name:r})}async restart(r){return o({cmd:"restart",name:r})}async delete(r){return o({cmd:"delete",name:r})}async stats(r){return o({cmd:"stats",name:r})}async list(){return o({cmd:"list"})}waitForDaemon(r){let t=Date.now(),n=200;return new Promise((e,i)=>{let s=()=>{this.isDaemonRunning().then(m=>{if(m)return e();if(Date.now()-t>r)return i(new Error("Daemon did not start in time"));setTimeout(s,n);});};setTimeout(s,n);})}},E=new u;export{u as a,E as b};